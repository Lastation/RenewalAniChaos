import variable_data as vd;
import getunitID as id;

const Lesson_Level = [0, 0, 0];

const s = StringBuffer();

function Lesson_Unit(cp);
function Lesson_Check(cp);
function Album_Unit(cp);

function Add_Weapon_Damage(ID, index);
function Add_Weapon_Increase(ID, index);

function Weapon_Text_Princess();
function Weapon_Text_Fairy();
function Weapon_Text_Angel();

function Marge(cp)
{
    	if (MemoryEPD(EPD(0x6284E8) + 12 * cp, AtLeast, 1)) 
    	{ Lesson_Check(cp); }
    	
    	Album_Unit(cp);
    	Lesson_Unit(cp);
}

function Lesson_Unit(cp)
{
	if (Bring(cp, AtLeast, 1, 126, "JewelGacha Step 1") && Lesson_Level[0] < 30)
	{
		KillUnitAt(1,  126, "JewelGacha Step 1", cp);
		// Weapon.dat
		Lesson_Level[0] += 1;
		
		for (var i = 0; i < 17; i++)
		{
			Add_Weapon_Damage(vd.Princess_Weapon_Index[i], Lesson_Level[0]);
		}
		s.print("\x13\x1BPrincess \x04타입 특훈 티켓을 사용하였습니다.");
		Weapon_Text_Princess();
	}	
	
	if (Bring(cp, AtLeast, 1, 127, "JewelGacha Step 1") && Lesson_Level[1] < 30)
	{
		KillUnitAt(1,  127, "JewelGacha Step 1", cp);
		// Weapon.dat
		Lesson_Level[1] += 1;
		
		for (var i = 0; i < 17; i++)
		{
			Add_Weapon_Damage(vd.Fairy_Weapon_Index[i], Lesson_Level[1]);
		}
		s.print("\x13\x1CFairy \x04타입 특훈 티켓을 사용하였습니다.");
		Weapon_Text_Fairy();
	}
	
	if (Bring(cp, AtLeast, 1, 135, "JewelGacha Step 1") && Lesson_Level[2] < 30)
	{
		KillUnitAt(1,  135, "JewelGacha Step 1", cp);
		// Weapon.dat
		Lesson_Level[2] += 1;
		
		for (var i = 0; i < 17; i++)
		{
			Add_Weapon_Damage(vd.Angel_Weapon_Index[i], Lesson_Level[2]);
		}
		s.print("\x13\x19Angel \x04타입 특훈 티켓을 사용하였습니다.");
		Weapon_Text_Angel();
	}
}

function Album_Unit(cp)
{
	if (Bring(cp, AtLeast, 1, 136, "JewelGacha Step 1"))
	{
    		var random = dwrand() % 17;
    		
		SetDeaths(P6, Add, vd.Album_Weapon_Damage[random], vd.Princess_Unit_Index[random]);
		SetDeaths(P7, Add, 1, vd.Princess_Unit_Index[random]);
		KillUnitAt(1,  136, "JewelGacha Step 1", cp);
		
		if (Deaths(cp, Exactly, 0, "unit_music_length"))
		{ SetDeaths(Force1, SetTo, 1 +  random, "unit_music_index"); }
		
		if (Deaths(P6, AtLeast, 400, vd.Princess_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Princess_Weapon_Index[random], 4);
			SetDeaths(P6, Subtract, 400, vd.Princess_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 300, vd.Princess_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Princess_Weapon_Index[random], 3);
			SetDeaths(P6, Subtract, 300, vd.Princess_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 200, vd.Princess_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Princess_Weapon_Index[random], 2);
			SetDeaths(P6, Subtract, 200, vd.Princess_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 100, vd.Princess_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Princess_Weapon_Index[random], 1);
			SetDeaths(P6, Subtract, 100, vd.Princess_Unit_Index[random]);
		}
	}
	
	if (Bring(cp, AtLeast, 1, 137, "JewelGacha Step 1"))
	{
    		var random = dwrand() % 17;
    		
		SetDeaths(P6, Add, vd.Album_Weapon_Damage[random], vd.Fairy_Unit_Index[random]);
		SetDeaths(P7, Add, 1, vd.Fairy_Unit_Index[random]);
		KillUnitAt(1,  137, "JewelGacha Step 1", cp);
		
		if (Deaths(cp, Exactly, 0, "unit_music_length"))
		{ SetDeaths(Force1, SetTo, 18 +  random, "unit_music_index"); }
		
		if (Deaths(P6, AtLeast, 400, vd.Fairy_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Fairy_Weapon_Index[random], 4);
			SetDeaths(P6, Subtract, 400, vd.Fairy_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 300, vd.Fairy_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Fairy_Weapon_Index[random], 3);
			SetDeaths(P6, Subtract, 300, vd.Fairy_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 200, vd.Fairy_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Fairy_Weapon_Index[random], 2);
			SetDeaths(P6, Subtract, 200, vd.Fairy_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 100, vd.Fairy_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Fairy_Weapon_Index[random], 1);
			SetDeaths(P6, Subtract, 100, vd.Fairy_Unit_Index[random]);
		}
	}
	
	if (Bring(cp, AtLeast, 1, 138, "JewelGacha Step 1"))
	{
    		var random = dwrand() % 17;
    		
		SetDeaths(P6, Add, vd.Album_Weapon_Damage[random], vd.Angel_Unit_Index[random]);
		SetDeaths(P7, Add, 1, vd.Angel_Unit_Index[random]);
		KillUnitAt(1,  138, "JewelGacha Step 1", cp);
		
		if (Deaths(cp, Exactly, 0, "unit_music_length"))
		{ SetDeaths(Force1, SetTo, 35 +  random, "unit_music_index"); }
		
		if (Deaths(P6, AtLeast, 400, vd.Angel_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Angel_Weapon_Index[random], 4);
			SetDeaths(P6, Subtract, 400, vd.Angel_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 300, vd.Angel_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Angel_Weapon_Index[random], 3);
			SetDeaths(P6, Subtract, 300, vd.Angel_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 200, vd.Angel_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Angel_Weapon_Index[random], 2);
			SetDeaths(P6, Subtract, 200, vd.Angel_Unit_Index[random]);
		}
		if (Deaths(P6, AtLeast, 100, vd.Angel_Unit_Index[random]))
		{
			Add_Weapon_Increase(vd.Angel_Weapon_Index[random], 1);
			SetDeaths(P6, Subtract, 100, vd.Angel_Unit_Index[random]);
		}
	}
}

function Lesson_Check(cp)
{
	switch(id.Unit_ID[cp])
	{
	// Princess
	case 27:
	case 88:
	case 99:
	case 100:
	case 61:
	case 65:
	case 66:
	case 67:
	case 68:
	case 70:
	case 71:
	case 74:
	case 75:
	case 76:
	case 77:
	case 78:
	case 79:
		s.printAt(0, "\x12",ptr2s(GetTBLAddr(id.Unit_ID[cp] + 1)));
		s.printAt(1, "\x12\x04앨범 ", "\x0F", dwread_epd(id.Unit_ID[cp] * 12 + 6), " \x04장");
		s.printAt(2, "\x12\x04팬 ", "\x0F", dwread_epd(id.Unit_ID[cp] * 12 + 7), " \x04명");
		s.printAt(3, "\n");
		break;
	// Fairy
	case 29:
	case 80:
	case 63:
	case 87:
	case 39:
	case 40:
	case 43:
	case 44:
	case 46:
	case 48:
	case 51:
	case 52:
	case 53:
	case 54:
	case 55:
	case 56:
	case 60:
		s.printAt(0, "\x12",ptr2s(GetTBLAddr(id.Unit_ID[cp] + 1)));
		s.printAt(1, "\x12\x04앨범 ", "\x0F", dwread_epd(id.Unit_ID[cp] * 12 + 6), " \x04장");
		s.printAt(2, "\x12\x04팬 ", "\x0F", dwread_epd(id.Unit_ID[cp] * 12 + 7), " \x04명");
		s.printAt(3, "\n");
		break;
	// Angel
	case 28:
	case 32:
	case 102:
	case 104:
	case 0:
	case 1:
	case 2:
	case 8:
	case 9:
	case 10:
	case 12:
	case 16:
	case 19:
	case 20:
	case 21:
	case 37:
	case 38:
		s.printAt(0, "\x12",ptr2s(GetTBLAddr(id.Unit_ID[cp] + 1)));
		s.printAt(1, "\x12\x04앨범 ", "\x0F", dwread_epd(id.Unit_ID[cp] * 12 + 6), " \x04장");
		s.printAt(2, "\x12\x04팬 ", "\x0F", dwread_epd(id.Unit_ID[cp] * 12 + 7), " \x04명");
		s.printAt(3, "\n");
		break;
	}
}

function Add_Weapon_Damage(ID, index)
{
	wwrite(0x6564E0 + 2512 + ID * 2, wread(0x6564E0 + 2512 + ID * 2) + vd.Lesson_Weapon_Damage[index]);		// 기본 데미지
}

function Add_Weapon_Increase(ID, value)
{
	wwrite(0x6564E0 + 4504 + ID * 2, wread(0x6564E0 + 4504 + ID * 2) + value);		// 업글 증가량
	KillUnitAt(1, 123, "JewelGacha", CurrentPlayer);
}

function Weapon_Text_Princess()
{
	settbl(240, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F매우느린 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
	
	settbl(241, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F느린 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
	
	settbl(242, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F보통\x04인 맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
	
	settbl(243, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F빠른 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
	
	settbl(244, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F매우 빠른 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
	
	settbl(245, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F뛰어난 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
	
	settbl(249, 0,"\x1B< 프린세스 >\n", 
	"\x04성장이 \x0F월등한 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[0]);
}

function Weapon_Text_Fairy()
{
	settbl(235, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F매우느린 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
	
	settbl(236, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F느린 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
	
	settbl(237, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F보통\x04인 맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
	
	settbl(238, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F빠른 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
	
	settbl(239, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F매우 빠른 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
	
	settbl(246, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F뛰어난 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
	
	settbl(248, 0,"\x1C< 페어리 >\n", 
	"\x04성장이 \x0F월등한 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[1]);
}

function Weapon_Text_Angel()
{
	settbl(229, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F매우느린 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
	
	settbl(230, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F느린 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
	
	settbl(231, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F보통\x04인 맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
	
	settbl(232, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F빠른 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
	
	settbl(233, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F매우 빠른 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
	
	settbl(234, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F뛰어난 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
	
	settbl(247, 0,"\x19< 엔젤 >\n", 
	"\x04성장이 \x0F월등한 \x04맴버입니다.\n", 
	"\x04특훈레벨 : \x19", Lesson_Level[2]);
}